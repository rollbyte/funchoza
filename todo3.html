<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Caviar test</title>
</head>
<body>
<style>

.current {
	background-color:navy;
	color:white;
}

.subs {
	margin-left:15px;
}

</style>

<script type="text/javascript" src="jquery-min.js"></script>
<script type="text/javascript" src="caviar.js"></script>
<script type="text/javascript">

	function Task(text){
		this.text = text;
		
		this.subTasks = [];
		
		this.parent = null;
		
		this.select = function(){
			if (todo.current !== this)
				todo.current = this;
			else
				todo.current = null;
		};
		
		this.isCurrent = function(){
			return todo.current === this;
		};
	}

	var todo = {
		current:null,
		
		mode: "none",

		taskList:[],
				
		addTask:function(element){
			var t = new Task(element.prev().val());
			element.prev().val("");
			if (this.current){
				t.parent = this.current;
				this.current.subTasks[this.current.subTasks.length] = t;
			} else
				this.taskList[this.taskList.length] = t;
		},
		
		done:function(){
			if (this.current.parent)
				this.current.parent.subTasks.splice(this.current.parent.subTasks.indexOf(this.current),1);
			else
				this.taskList.splice(this.taskList.indexOf(this.current),1);
			delete this.current.parent;
			delete this.current;
		},
				
		tasksCount:function(){
			return this.taskList.length;
		},
		
		modes: [{id:"none", title:"нет"},{id:"yes",title:"есть"}],
	};
</script>
<div cvr-scope="todo">
	<div>
		<input type="text" value="" /><button cvr-handlers="click:addTask">Добавить</button>
	</div>
	<div>У вас <span cvr-data="tasksCount"></span> задач</div>
	<div cvr-foreach="taskList" cvr-watch-parent="true" cvr-watch-children="true">
		<div cvr-tpl="todo3task"></div>
	</div>
	<button cvr-handlers="click:done">Готово!</button>
	<div>
	<span cvr-data="mode"></span><select cvr-data="mode" cvr-foreach="modes"><option cvr-attrs="value:id" cvr-data="title"></option></select>
	</div>
</div>
<template id="todo3task">
<div>
	<div cvr-data="text" cvr-handlers="click:select" cvr-classes="current:isCurrent"></div>
	<div cvr-foreach="subTasks" cvr-watch-children="true" class="subs">
		<div cvr-tpl="todo3task"></div>
	</div>
</div>
</template>
</body>
</html>