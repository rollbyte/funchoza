var Caviar={rootScope:null,id:1,scopes:{},bindings:{},CvrBinding:function(c,b,a){this.Scope=c;this.DOMElement=b;this.Invalidator=a;this.elementTemplate="";},CvrScope:function(d,c,b,a){this.Parent=c;this.ReactOnParent=b;this.ReactOnChildren=a;this.Children=[];this.Bindings=[];this.Path=d;this.AddChild=function(f){this.Children[this.Children.length]=f;};this.AddBinding=function(f){this.Bindings[this.Bindings.length]=f;};this.Invalidate=function(g){var f;for(f=0;f<this.Bindings.length;f++){this.Bindings[f].Invalidator();}if(this.Parent!=null){if(this.Parent.ReactOnChildren===true){this.Parent.Invalidate(this);}}for(f=0;f<this.Children.length;f++){if(this.Children[f].ReactOnParent===true&&this.Children[f]!==g){this.Children[f].InvalidateBranch(false);}}};this.InvalidateBranch=function(g){var f;for(f=0;f<this.Bindings.length;f++){this.Bindings[f].Invalidator();}for(f=0;f<this.Children.length;f++){if(g===true||this.Children[f].ReactOnParent===true){this.Children[f].InvalidateBranch(g);}}};},NextBid:function(){var a="cvr-"+this.id;this.id++;return a;},ScopeModel:function(scope){var m=window;if(scope.Path!==""){try{m=eval("window."+scope.Path);}catch(err){return undefined;}}return m;},Invalidate:function(a){if(a==null){this.rootScope.InvalidateBranch(true);}else{this.bindings[$(a).attr("cvr-bid")].Invalidate();}},InvalidatePath:function(a){if(a==null){this.rootScope.InvalidateBranch(true);}else{this.scopes[a].Invalidate();}},ClearScope:function(d,a){var c,b;for(c=0;c<d.Children.length;c++){delete d.Children[c].Parent;this.ClearScope(d.Children[c],true);delete this.scopes[d.Children[c].Path];}d.Children.length=0;if(a===true){for(c=0;c<d.Bindings.length;c++){b=$(d.Bindings[c].DOMElement).attr("cvr-bid");delete d.Bindings[c].DOMElement;delete d.Bindings[c].Scope;delete this.bindings[b];}d.Bindings.length=0;delete d.Parent;delete this.scopes[d.Path];}},SetModelValue:function(scope,property,value){var m,root,prop;m=Caviar.ScopeModel(scope);if("undefined"!=typeof m&&m!=null){root="m.";if(property.substring(0,2)=="$."){property=property.slice(2);root="window.";}try{prop=eval(root+property+";");}catch(err){prop=null;}if("function"==typeof prop){eval(root+property+"(value);");}else{eval(root+property+" = value;");}scope.Invalidate();}},Evaluate:function(model,property,domelement,callback){if(property=="@scope"){return model;}var value,root,args,i,model2,li;value=null;if("undefined"!=typeof model&&model!=null){root="model.";if(property.substring(0,2)=="$."){property=property.slice(2);root="window.";}if(property.indexOf("(")>-1){args=property.substring(property.indexOf("(")+1,property.lastIndexOf(")")).split(",");property=property.substring(0,property.indexOf("(")+1);for(i=0;i<args.length;i++){if(args[i].indexOf('"')==-1&&!$.isNumeric(args[i])){args[i]='Caviar.Evaluate(model,"'+args[i]+'")';}}if("undefined"!=typeof domelement){args[args.length]="domelement";}if("undefined"!=typeof callback){args[args.length]="callback";}property=property+args.join(",")+")";}try{value=eval(root+property+";");}catch(err){value=null;}if("function"==typeof value){args=[];if("undefined"!=typeof domelement){args[args.length]=domelement;}if("undefined"!=typeof callback){args[args.length]=callback;}li=property.lastIndexOf(".");if(li>-1){model2=eval(root+property.substring(0,li-1)+";");value=value.apply(model2,args);}else{value=value.apply(model,args);}}}return value;},ApplyValue:function(a,b){var d,c;d=b.attr("cvr-data");if("undefined"!=typeof d){c=this.Evaluate(a,d);b.text(c).val(c);}},ApplyStyles:function(b,d){var a,g,f,c;a=d.attr("cvr-style");if("undefined"!=typeof a){g=a.split(";");for(c=0;c<g.length;c++){f=g[c].split(":");if(f.length>1){d.css(f[0].trim(),this.Evaluate(b,f[1].trim()));}}}},ApplyClasses:function(d,h){var a,g,j,b,f;a=h.attr("cvr-classes");if("undefined"!==typeof a){g=a.split(";");for(f=0;f<g.length;f++){j=g[f].split(":");if(j.length>1){b=this.Evaluate(d,j[1].trim());if(b){h.addClass(j[0].trim());}else{h.removeClass(j[0].trim());}}}}},ApplyForeach:function(j,g,c){if("undefined"==typeof g||g==null||g.length==0){c.html("");this.ClearScope(j.Scope);}else{var d,h,f,b,l,a,k;if(!this.Fire(j.Scope,g,c).isDefaultPrevented()){h=[];for(d=0;d<j.Scope.Children.length;d++){b=this.ScopeModel(j.Scope.Children[d]);if("undefined"==typeof b||b==null){f=j.Scope.Children[d].Path.substring(j.Scope.Children[d].Path.lastIndexOf("[")+1,j.Scope.Children[d].Path.lastIndexOf("]"));c.children("[cvr-sp='"+f+"']").remove();this.ClearScope(j.Scope.Children[d],true);}else{h[h.length]=j.Scope.Children[d];j.Scope.Children[d].InvalidateBranch(true);}}j.Scope.Children=h;for(d in g){l=j.Scope.Path+"["+d+"]";if("undefined"==typeof this.scopes[l]){a=$.parseHTML(j.elementTemplate)[0];$(a).attr("cvr-sp",d);k=new Caviar.CvrScope(l,j.Scope,false,true);this.scopes[l]=k;j.Scope.AddChild(k);this.Bind(a,l);c.append(a);k.InvalidateBranch(true);}}}}},Fire:function(c,a,b){e=jQuery.Event("caviar-invalidate",{scope:c,model:a});b.trigger(e);return e;},Bind:function(c,d){var b,a;if(d==null){b=Caviar.rootScope;}else{b=Caviar.scopes[d];}this.ClearScope(b);a=function(){var z,k,u,B,n,p,j,q,y,C,l,A,x,g,f,v,r,o,t,w;z=$(this);k=[];u=false;B;n;if("undefined"!=typeof z.attr("cvr-scope")){k=z.attr("cvr-scope").split(".");if("undefined"!=typeof z.attr("cvr-watch-parent")){B=Boolean(z.attr("cvr-watch-parent"));}if("undefined"!=typeof z.attr("cvr-watch-children")){n=Boolean(z.attr("cvr-watch-children"));}if(k[0]==="$"){k.shift();u=true;}}if(!u){z.parentsUntil(c,"[cvr-scope]").each(function(){var i,h;i=$(this);h=i.attr("cvr-scope").split(".");if(h[0]==="$"){u=true;h.shift();}k=h.concat(k);if("undefined"==typeof B){if("undefined"!=typeof i.attr("cvr-watch-parent")){B=Boolean(i.attr("cvr-watch-parent"));}else{B=false;}}if("undefined"==typeof n){if("undefined"!=typeof i.attr("cvr-watch-children")){n=Boolean(i.attr("cvr-watch-children"));}else{n=true;}}return !u;});}p=b;j=((b.Path=="")?"":(b.Path+"."))+k.join(".");if("undefined"!=typeof Caviar.scopes[j]){p=Caviar.scopes[j];}else{j=b.Path;for(q=0;q<k.length;q++){j=(j==""?"":(j+"."))+k[q];if("undefined"==typeof Caviar.scopes[j]){l=new Caviar.CvrScope(j,p,B,n);p.AddChild(l);Caviar.scopes[j]=l;p=l;}else{p=Caviar.scopes[j];}}}y="var m = Caviar.ScopeModel(this.Scope);var el = $(this.DOMElement);";if("undefined"!=typeof z.attr("cvr-bind")){A=z.attr("cvr-bind");x=false;if(A.indexOf("write")>-1||A.indexOf("data")>-1){g=z.get(0).tagName.toLowerCase();if(g==="select"||g==="textarea"||g=="input"){z.change(function(){Caviar.SetModelValue(p,z.attr("cvr-data"),$(this).val());});}}if(A.indexOf("read")>-1||A.indexOf("data")>-1){y=y+"if (!Caviar.Fire(this.Scope,m,el).isDefaultPrevented()) Caviar.ApplyValue(m,el);";x=true;}if(A.indexOf("style")>-1){y=y+"Caviar.ApplyStyles(m,el);";x=true;}if(A.indexOf("classes")>-1){y=y+"Caviar.ApplyClasses(m,el);";x=true;}if(A.indexOf("events")>-1){f=z.attr("cvr-handlers").split(";");for(q=0;q<f.length;q++){v=f[q].split(":");if(v.length>1){r=v[1].trim();z.bind(v[0].trim(),function(){o=Caviar.ScopeModel(p);if(Caviar.Evaluate(o,r,$(this),function(){p.Invalidate();})!==false){p.Invalidate();}});}}}}if("undefined"!=typeof z.attr("cvr-foreach")){y=y+"Caviar.ApplyForeach(this,m,el);";C=z.html().trim();z.html("");x=true;}if(x){t=Caviar.NextBid();z.attr("cvr-bid",t);w=new Caviar.CvrBinding(p,this,new Function(y));if("undefined"!=typeof C){w.elementTemplate=C;}p.AddBinding(w);Caviar.bindings[t]=p;}};$("[cvr-bind],[cvr-foreach]",c).not($("[cvr-foreach]",c).find("[cvr-bind]")).each(a);if("undefined"!=typeof $(c).attr("cvr-bind")){a.apply(c);}}};$(document).ready(function(){Caviar.rootScope=new Caviar.CvrScope("",null,false,true);Caviar.scopes[""]=Caviar.rootScope;Caviar.Bind(window.document,null);Caviar.Invalidate(null);});